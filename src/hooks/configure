#!/bin/sh

# Supported keys:
# - ports.http (integer)
#   Port on which the snap will listen for HTTP traffic.
#
# - ports.https (integer)
#   Port on which the snap will listen for HTTPS traffic (only applies if HTTPS
#   is enabled).

. $SNAP/utilities/apache-utilities

handle_apache_port_config()
{
	old_http_port="$(apache_http_port)"
	old_https_port="$(apache_https_port)"

	http_port="$(snapctl get ports.http)"
	if [ -z "$http_port" ]; then
		http_port="$old_http_port"
		snapctl set ports.http="$http_port"
	fi

	https_port="$(snapctl get ports.https)"
	if [ -z "$https_port" ]; then
		https_port="$old_https_port"
		snapctl set ports.https="$https_port"
	fi

	# If no changes were requested, then there's nothing to do here.
	if [ "$http_port" = "$old_http_port" -a "$https_port" = "$old_https_port" ]; then
		return 0
	fi

	# Validate HTTP port
	if ! expr "$http_port" : '^[0-9]*$' > /dev/null; then
		echo "\"$http_port\" is not a valid HTTP port" >&2
		return 1
	fi

	# Validate HTTPS port
	if ! expr "$https_port" : '^[0-9]*$' > /dev/null; then
		echo "\"$https_port\" is not a valid HTTPS port" >&2
		return 2
	fi

	apache_set_http_port "$http_port"
	apache_set_https_port "$https_port"

	# If restarting ran into problems, revert the change before erroring out.
	if ! restart_apache_if_running; then
		apache_set_http_port "$old_http_port"
		apache_set_https_port "$old_https_port"
		restart_apache_if_running
		return 3
	fi
}

handle_apache_port_config
